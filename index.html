<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
        }

        .categories {
            display: flex;
            gap: 8px;
            padding: 16px 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .category-button {
            padding: 8px 16px;
            border: 1px solid #eee;
            border-radius: 20px;
            background: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .category-button.active {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            padding: 16px 0;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .product-card:hover {
            transform: translateY(-2px);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-info {
            padding: 12px;
        }

        .product-title {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }

        .product-description {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .product-price {
            margin: 8px 0;
            font-weight: bold;
            color: var(--tg-theme-button-color);
        }

        .add-to-cart {
            width: 100%;
            padding: 8px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .cart-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 12px 24px;
            border-radius: 24px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cart-count {
            background-color: white;
            color: var(--tg-theme-button-color);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .product-sizes {
            display: flex;
            gap: 8px;
            margin: 8px 0;
        }

        .size-button {
            padding: 4px 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            background: none;
            cursor: pointer;
            font-size: 12px;
        }

        .size-button.selected {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        .size-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            color: #ff4444;
            font-size: 12px;
            margin: 4px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Fashion Store</h1>
        </div>

        <div class="categories">
            <button class="category-button active" onclick="filterProducts('all')">All</button>
            <button class="category-button" onclick="filterProducts('shirts')">Shirts</button>
            <button class="category-button" onclick="filterProducts('pants')">Pants</button>
            <button class="category-button" onclick="filterProducts('shoes')">Shoes</button>
            <button class="category-button" onclick="filterProducts('accessories')">Accessories</button>
        </div>

        <div class="products-grid" id="products"></div>

        <button class="cart-button" onclick="viewCart()">
            Cart <span class="cart-count" id="cartCount">0</span>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let cart = [];
        let selectedSizes = {};

        // Fetch products from backend
        async function fetchProducts(category = 'all') {
            try {
                const response = await fetch(`/api/products?category=${category}`);
                const data = await response.json();
                return data.products;
            } catch (error) {
                console.error('Error fetching products:', error);
                tg.showPopup({
                    title: 'Error',
                    message: 'Failed to load products. Please try again.',
                    buttons: [{type: 'ok'}]
                });
                return [];
            }
        }

        async function renderProducts(filterCategory = 'all') {
            const productsContainer = document.getElementById('products');
            productsContainer.innerHTML = '<p>Loading products...</p>';

            const products = await fetchProducts(filterCategory);
            productsContainer.innerHTML = '';

            products.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'product-card';
                productElement.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <p class="product-description">${product.description}</p>
                        <p class="product-price">$${product.price}</p>
                        <div class="product-sizes">
                            ${product.sizes.map(size => `
                                <button 
                                    class="size-button ${!(product.inventory && product.inventory[size]) ? 'disabled' : ''} ${selectedSizes[product.id] === size ? 'selected' : ''}"
                                    onclick="selectSize(${product.id}, '${size}')"
                                    ${!(product.inventory && product.inventory[size]) ? 'disabled' : ''}
                                >${size}</button>
                            `).join('')}
                        </div>
                        <p class="error-message" id="error-${product.id}">Please select a size</p>
                        <button class="add-to-cart" onclick="addToCart(${product.id})">Add to Cart</button>
                    </div>
                `;
                productsContainer.appendChild(productElement);
            });
        }

        async function checkout() {
            if (!tg.initDataUnsafe.user) {
                tg.showPopup({
                    title: 'Error',
                    message: 'Please open this store through Telegram.',
                    buttons: [{type: 'ok'}]
                });
                return;
            }

            const orderItems = cart.map(item => ({
                id: item.id,
                size: item.selectedSize
            }));

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: tg.initDataUnsafe.user.id,
                        items: orderItems
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    cart = [];
                    updateCartCount();
                    tg.showPopup({
                        title: 'Success',
                        message: 'Your order has been placed! Order ID: ' + data.order.id,
                        buttons: [{type: 'ok'}]
                    });
                    tg.MainButton.hide();
                } else {
                    throw new Error(data.error || 'Failed to place order');
                }
            } catch (error) {
                tg.showPopup({
                    title: 'Error',
                    message: error.message || 'Failed to place order. Please try again.',
                    buttons: [{type: 'ok'}]
                });
            }
        }

        function selectSize(productId, size) {
            const product = products.find(p => p.id === productId);
            if (!product.availableSizes.includes(size)) return;
            
            selectedSizes[productId] = size;
            document.getElementById(`error-${productId}`).style.display = 'none';
            renderProducts(document.querySelector('.category-button.active').textContent.toLowerCase());
        }

        function filterProducts(category) {
            document.querySelectorAll('.category-button').forEach(button => {
                button.classList.remove('active');
                if(button.textContent.toLowerCase() === category || 
                   (category === 'all' && button.textContent === 'All')) {
                    button.classList.add('active');
                }
            });
            renderProducts(category);
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const errorElement = document.getElementById(`error-${productId}`);
            
            if (!selectedSizes[productId] && product.sizes.length > 1) {
                errorElement.style.display = 'block';
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            const size = selectedSizes[productId] || product.sizes[0];
            const cartItem = {
                ...product,
                selectedSize: size
            };
            
            cart.push(cartItem);
            updateCartCount();
            tg.HapticFeedback.impactOccurred('light');
        }

        function updateCartCount() {
            document.getElementById('cartCount').textContent = cart.length;
        }

        function viewCart() {
            if (cart.length === 0) {
                tg.showPopup({
                    title: 'Cart is Empty',
                    message: 'Add some items to your cart first!',
                    buttons: [{type: 'ok'}]
                });
                return;
            }

            const total = cart.reduce((sum, item) => sum + item.price, 0).toFixed(2);
            const cartItems = cart.map(item => 
                `${item.name} - Size: ${item.selectedSize} - $${item.price}`
            ).join('\n');
            
            tg.showPopup({
                title: 'Your Cart',
                message: `${cartItems}\n\nTotal: $${total}`,
                buttons: [
                    {type: 'ok', id: 'checkout', text: 'Checkout'},
                    {type: 'cancel', text: 'Continue Shopping'}
                ]
            }).then(button => {
                if (button === 'checkout') {
                    checkout();
                }
            });
        }

        // Initialize
        tg.ready();
        tg.expand();
        
        // Set up main button for checkout
        tg.MainButton.setText('Checkout');
        tg.MainButton.onClick(checkout);

        // Initial product load
        renderProducts();

        // Handle theme changes
        tg.onEvent('themeChanged', () => {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
        });
    </script>
</body>
</html>
